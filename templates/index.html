<!DOCTYPE html>
<html>
<head>
    <title>Kamil Web Interface</title>
    <style>
        /* ... existing styles ... */
        
        /* File browser styles */
        .file-browser {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .file-item:hover {
            background-color: #f0f8ff;
        }
        
        .file-item.directory {
            font-weight: bold;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .file-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
        }
        
        .editor-container {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        
        #editor {
            width: 100%;
            height: 100%;
            font-family: 'Fira Code', monospace;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
</head>
<body>
    <div class="header">
        <h1>Kamil AI Assistant</h1>
        <p>Advanced conversational AI with file management</p>
    </div>
    
    <div class="file-browser" id="file-browser">
        <h3>Workspace Files <button onclick="refreshFileList()">Refresh</button></h3>
        <div id="file-list">Loading files...</div>
    </div>
    
    <div id="chat-box">
        <div class="message system-message">
            Welcome to Kamil! I'm your AI assistant. How can I help you today?
        </div>
    </div>
    
    <div class="typing-indicator" id="typing-indicator">
        Kamil is thinking...
    </div>
    
    <div class="input-container">
        <input type="text" id="user-input" placeholder="Type your message or file command..." autocomplete="off">
        <button id="send-btn" onclick="sendMessage()">Send</button>
    </div>
    
    <div class="file-modal" id="file-modal">
        <h3 id="modal-title">File Editor</h3>
        <div class="editor-container">
            <div id="editor"></div>
        </div>
        <div class="file-actions">
            <button id="save-btn" onclick="saveFile()">Save</button>
            <button onclick="executeFile()">Execute</button>
            <button onclick="closeModal()">Close</button>
        </div>
        <div id="file-result" style="margin-top: 10px;"></div>
    </div>

    <script>
        // DOM elements
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const fileList = document.getElementById('file-list');
        const fileModal = document.getElementById('file-modal');
        const editor = ace.edit("editor");
        const saveBtn = document.getElementById('save-btn');
        const modalTitle = document.getElementById('modal-title');
        const fileResult = document.getElementById('file-result');
        
        // Initialize ACE editor
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");
        editor.setFontSize(14);
        
        let currentFile = null;
        let editorMode = 'create'; // 'create' or 'edit'
        
        // Focus input on load
        userInput.focus();
        
        // File browser functions
        function refreshFileList() {
            fetch('/file_operation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ operation: 'list' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result && Array.isArray(data.result)) {
                    renderFileList(data.result);
                } else {
                    fileList.innerHTML = "Error loading files";
                }
            });
        }
        
        function renderFileList(files) {
            let html = '';
            files.forEach(file => {
                const fileType = file.type === 'directory' ? 'üìÅ' : 'üìÑ';
                const fileClass = file.type === 'directory' ? 'directory' : '';
                html += `<div class="file-item ${fileClass}" onclick="handleFileClick('${file.name}', '${file.type}')">
                    ${fileType} ${file.name}
                </div>`;
            });
            fileList.innerHTML = html || "No files found";
        }
        
        function handleFileClick(filename, type) {
            if (type === 'directory') return;
            
            fetch('/file_operation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    operation: 'read', 
                    filename: filename 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result) {
                    currentFile = filename;
                    modalTitle.textContent = `Editing: ${filename}`;
                    editor.setValue(data.result);
                    editorMode = 'edit';
                    fileModal.style.display = 'block';
                } else {
                    alert('Error reading file');
                }
            });
        }
        
        function openFileCreator() {
            currentFile = null;
            modalTitle.textContent = "Create New File";
            editor.setValue("");
            editorMode = 'create';
            fileModal.style.display = 'block';
        }
        
        function closeModal() {
            fileModal.style.display = 'none';
            fileResult.innerHTML = '';
        }
        
        function saveFile() {
            const content = editor.getValue();
            
            if (!currentFile && editorMode === 'create') {
                const filename = prompt("Enter filename:");
                if (!filename) return;
                currentFile = filename;
            }
            
            const operation = editorMode === 'create' ? 'create' : 'modify';
            
            fetch('/file_operation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    operation: operation, 
                    filename: currentFile, 
                    content: content 
                })
            })
            .then(response => response.json())
            .then(data => {
                fileResult.innerHTML = `<div class="system-message">${data.result}</div>`;
                refreshFileList();
            });
        }
        
        function executeFile() {
            if (!currentFile) {
                fileResult.innerHTML = '<div class="system-message">No file selected</div>';
                return;
            }
            
            fetch('/file_operation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    operation: 'execute', 
                    filename: currentFile 
                })
            })
            .then(response => response.json())
            .then(data => {
                fileResult.innerHTML = `<div class="system-message">Execution Result:</div>
                <pre class="code-block">${data.result}</pre>`;
            });
        }
        
        // ... existing message functions ...
        
        // Initialize file browser
        refreshFileList();
    </script>
</body>
</html>
